# If you want the grand total annotation inside the plot:
p_stacked +
annotate(
"text",
x = max(month_totals$ym),
y = max_month_total * 1.06,
label = paste0("Grand total: ", comma(grand_total)),
hjust = 1, vjust = 0, fontface = "bold"
)
# ---- 4) Chart B: small-multiples per Region (free y-scale, same colors) ----
p_facets <- ggplot(df_plot, aes(x = ym, y = volume, fill = Region)) +
geom_col(show.legend = FALSE) +
facet_wrap(~ Region, scales = "free_y") +
scale_fill_manual(values = pal) +   # <- same colors as stacked chart
scale_y_continuous(labels = label_comma(),
expand = expansion(mult = c(0, 0.05))) +
scale_x_date(date_breaks = "1 month", date_labels = "%b\n%Y",
expand = c(0.01, 0.01)) +
labs(
title = "TNS Trip Volume by Region (Sep 2024 – Aug 2025)",
subtitle = "Each panel uses its own y-scale",
x = NULL, y = "Trips (volume)"
) +
theme_minimal(base_size = 12) +
theme(panel.grid.minor = element_blank(),
strip.text = element_text(face = "bold"),
axis.text.x = element_text(vjust = 1, hjust = 0.5))
p_facets
p_stacked
p_facets
p_facets
# ---- 4) Chart B: small-multiples per Region (free y-scale, same colors) ----
p_facets <- ggplot(df_plot, aes(x = ym, y = volume, fill = Region)) +
geom_col(show.legend = FALSE) +
facet_wrap(~ Region, scales = "free_y") +
scale_fill_manual(values = pal) +
scale_y_continuous(labels = label_comma(),
expand = expansion(mult = c(0, 0.05))) +
scale_x_date(date_breaks = "1 month",
date_labels = "%b\n%y",          # << 2-digit year here too
expand = c(0.01, 0.01)) +
labs(
title = "TNS Trip Volume by Region (Sep ’24 – Aug ’25)",
subtitle = "Each panel uses its own y-scale",
x = NULL, y = "Trips (volume)"
) +
theme_minimal(base_size = 12) +
theme(panel.grid.minor = element_blank(),
strip.text = element_text(face = "bold"),
axis.text.x = element_text(vjust = 1, hjust = 0.5))
p_facets
# Packages
library(dplyr)
library(lubridate)
library(stringr)
library(ggplot2)
library(forcats)
library(scales)
# ---- 1) Filter & prepare (rename to Region) ----
df_plot <- df %>%
filter(
TRIP_SERVICE_TYPE_CODE == "TNS",
GEOSPATIAL_AREA_TYPE_CODE == "TNS_ZONE"
) %>%
mutate(
ym = make_date(yr, mth, 1),
# Clean raw zone text
zone_raw = str_trim(PICKUP_AREA),
zone_raw = na_if(zone_raw, ""),
zone_raw = if_else(!is.na(zone_raw) & str_to_upper(zone_raw) %in% c("NA","N/A","UNKNOWN"),
NA_character_, zone_raw),
# Extract numeric id (e.g., "ZONE 1" -> 1)
region_num = suppressWarnings(as.integer(str_extract(zone_raw, "\\d+"))),
# Friendly label + ordering key (Unknown last)
Region      = if_else(is.na(region_num), "Unknown area", paste0("Region ", region_num)),
region_order= if_else(is.na(region_num), 999L, region_num)
) %>%
# Window Sep 2024 ... Aug 2025
filter(ym >= as.Date("2024-09-01"), ym < as.Date("2025-09-01")) %>%
group_by(ym, Region, region_order) %>%
summarise(volume = sum(volume, na.rm = TRUE), .groups = "drop") %>%
mutate(Region = fct_reorder(Region, region_order, .desc = FALSE))
# Month totals + grand total
month_totals <- df_plot %>%
group_by(ym) %>%
summarise(total = sum(volume), .groups = "drop")
grand_total     <- sum(month_totals$total)
max_month_total <- max(month_totals$total)
# ---- 2) Lock a shared palette so both charts match ----
regions <- levels(df_plot$Region)
pal     <- setNames(scales::hue_pal()(length(regions)), regions)
# ---- 3) Chart A: stacked monthly total by Region (labels + same colors) ----
p_stacked <- ggplot(df_plot, aes(x = ym, y = volume, fill = Region)) +
geom_col() +
geom_text(
data = month_totals,
aes(x = ym, y = total, label = comma(total)),
vjust = -0.25, size = 3.5, fontface = "bold", inherit.aes = FALSE
) +
scale_fill_manual(values = pal) +
scale_y_continuous(labels = label_comma(),
expand = expansion(mult = c(0, 0.10))) +
scale_x_date(date_breaks = "1 month", date_labels = "%b\n%Y",
expand = c(0.01, 0.01)) +
labs(
title = "TNS Trip Volume by Region",
subtitle = "(Sep 2024 – Aug 2025)",
x = NULL, y = "Trips (volume)",
fill = "Region",
caption = paste0("Grand total: ", comma(grand_total))
) +
theme_minimal(base_size = 12) +
theme(panel.grid.minor = element_blank(),
axis.text.x = element_text(vjust = 1, hjust = 0.5))
p_stacked
# If you want the grand total annotation inside the plot:
p_stacked +
annotate(
"text",
x = max(month_totals$ym),
y = max_month_total * 1.06,
label = paste0("Grand total: ", comma(grand_total)),
hjust = 1, vjust = 0, fontface = "bold"
)
# ---- 4) Chart B: small-multiples per Region (free y-scale, same colors) ----
p_facets <- ggplot(df_plot, aes(x = ym, y = volume, fill = Region)) +
geom_col(show.legend = FALSE) +
facet_wrap(~ Region, scales = "free_y") +
scale_fill_manual(values = pal) +   # <- same colors as stacked chart
scale_y_continuous(labels = label_comma(),
expand = expansion(mult = c(0, 0.05))) +
scale_x_date(date_breaks = "1 month", date_labels = "%b\n%Y",
expand = c(0.01, 0.01)) +
labs(
title = "TNS Trip Volume by Region (Sep 2024 – Aug 2025)",
subtitle = "Each panel uses its own y-scale",
x = NULL, y = "Trips (volume)"
) +
theme_minimal(base_size = 12) +
theme(panel.grid.minor = element_blank(),
strip.text = element_text(face = "bold"),
axis.text.x = element_text(vjust = 1, hjust = 0.5))
p_stacked
p_facets
p_stacked
# Packages
library(dplyr)
library(lubridate)
library(stringr)
library(ggplot2)
library(forcats)
library(scales)
# ---- 1) Filter & prepare (rename to Region) ----
df_plot <- df %>%
filter(
TRIP_SERVICE_TYPE_CODE == "TNS",
GEOSPATIAL_AREA_TYPE_CODE == "TNS_ZONE"
) %>%
mutate(
ym = make_date(yr, mth, 1),
# Clean raw zone text
zone_raw = str_trim(PICKUP_AREA),
zone_raw = na_if(zone_raw, ""),
zone_raw = if_else(!is.na(zone_raw) & str_to_upper(zone_raw) %in% c("NA","N/A","UNKNOWN"),
NA_character_, zone_raw),
# Extract numeric id (e.g., "ZONE 1" -> 1)
region_num = suppressWarnings(as.integer(str_extract(zone_raw, "\\d+"))),
# Friendly label + ordering key (Unknown last)
Region      = if_else(is.na(region_num), "Unknown area", paste0("Region ", region_num)),
region_order= if_else(is.na(region_num), 999L, region_num)
) %>%
# Window Sep 2024 ... Aug 2025
filter(ym >= as.Date("2024-09-01"), ym < as.Date("2025-09-01")) %>%
group_by(ym, Region, region_order) %>%
summarise(volume = sum(volume, na.rm = TRUE), .groups = "drop") %>%
mutate(Region = fct_reorder(Region, region_order, .desc = FALSE))
# Month totals + grand total
month_totals <- df_plot %>%
group_by(ym) %>%
summarise(total = sum(volume), .groups = "drop")
grand_total     <- sum(month_totals$total)
max_month_total <- max(month_totals$total)
# ---- 2) Lock a shared palette so both charts match ----
regions <- levels(df_plot$Region)
pal     <- setNames(scales::hue_pal()(length(regions)), regions)
# ---- 3) Chart A: stacked monthly total by Region (labels + same colors) ----
p_stacked <- ggplot(df_plot, aes(x = ym, y = volume, fill = Region)) +
geom_col() +
geom_text(
data = month_totals,
aes(x = ym, y = total, label = comma(total)),
vjust = -0.25, size = 3.5, fontface = "bold", inherit.aes = FALSE
) +
scale_fill_manual(values = pal) +
scale_y_continuous(labels = label_comma(),
expand = expansion(mult = c(0, 0.10))) +
scale_x_date(date_breaks = "1 month", date_labels = "%b\n%Y",
expand = c(0.01, 0.01)) +
labs(
title = "TNS Trip Volume by Region",
subtitle = "(Sep 2024 – Aug 2025)",
x = NULL, y = "Trips (volume)",
fill = "Region") +
theme_minimal(base_size = 12) +
theme(panel.grid.minor = element_blank(),
axis.text.x = element_text(vjust = 1, hjust = 0.5))
p_stacked
# If you want the grand total annotation inside the plot:
p_stacked +
annotate(
"text",
x = max(month_totals$ym),
y = max_month_total * 1.06,
label = paste0("Grand total: ", comma(grand_total)),
hjust = 1, vjust = 0, fontface = "bold"
)
# ---- 4) Chart B: small-multiples per Region (free y-scale, same colors) ----
p_facets <- ggplot(df_plot, aes(x = ym, y = volume, fill = Region)) +
geom_col(show.legend = FALSE) +
facet_wrap(~ Region, scales = "free_y") +
scale_fill_manual(values = pal) +   # <- same colors as stacked chart
scale_y_continuous(labels = label_comma(),
expand = expansion(mult = c(0, 0.05))) +
scale_x_date(date_breaks = "1 month", date_labels = "%b\n%Y",
expand = c(0.01, 0.01)) +
labs(
title = "TNS Trip Volume by Region (Sep 2024 – Aug 2025)",
subtitle = "Each panel uses its own y-scale",
x = NULL, y = "Trips (volume)"
) +
theme_minimal(base_size = 12) +
theme(panel.grid.minor = element_blank(),
strip.text = element_text(face = "bold"),
axis.text.x = element_text(vjust = 1, hjust = 0.5))
p_stacked
p_facets
# Packages
library(dplyr)
library(lubridate)
library(stringr)
library(ggplot2)
library(forcats)
library(scales)
# ---- 1) Filter & prepare (rename to Region) ----
df_plot <- df %>%
filter(
TRIP_SERVICE_TYPE_CODE == "TNS",
GEOSPATIAL_AREA_TYPE_CODE == "TNS_ZONE"
) %>%
mutate(
ym = make_date(yr, mth, 1),
# Clean raw zone text
zone_raw = str_trim(PICKUP_AREA),
zone_raw = na_if(zone_raw, ""),
zone_raw = if_else(!is.na(zone_raw) & str_to_upper(zone_raw) %in% c("NA","N/A","UNKNOWN"),
NA_character_, zone_raw),
# Extract numeric id (e.g., "ZONE 1" -> 1)
region_num = suppressWarnings(as.integer(str_extract(zone_raw, "\\d+"))),
# Friendly label + ordering key (Unknown last)
Region      = if_else(is.na(region_num), "Unknown area", paste0("Region ", region_num)),
region_order= if_else(is.na(region_num), 999L, region_num)
) %>%
# Window Sep 2024 ... Aug 2025
filter(ym >= as.Date("2024-09-01"), ym < as.Date("2025-09-01")) %>%
group_by(ym, Region, region_order) %>%
summarise(volume = sum(volume, na.rm = TRUE), .groups = "drop") %>%
mutate(Region = fct_reorder(Region, region_order, .desc = FALSE))
# Month totals + grand total
month_totals <- df_plot %>%
group_by(ym) %>%
summarise(total = sum(volume), .groups = "drop")
grand_total     <- sum(month_totals$total)
max_month_total <- max(month_totals$total)
# ---- 2) Lock a shared palette so both charts match ----
regions <- levels(df_plot$Region)
pal     <- setNames(scales::hue_pal()(length(regions)), regions)
# ---- 3) Chart A: stacked monthly total by Region (labels + same colors) ----
p_stacked <- ggplot(df_plot, aes(x = ym, y = volume, fill = Region)) +
geom_col() +
geom_text(
data = month_totals,
aes(x = ym, y = total, label = comma(total)),
vjust = -0.25, size = 3.5, fontface = "bold", inherit.aes = FALSE
) +
scale_fill_manual(values = pal) +
scale_y_continuous(labels = label_comma(),
expand = expansion(mult = c(0, 0.10))) +
scale_x_date(date_breaks = "1 month", date_labels = "%b\n%Y",
expand = c(0.01, 0.01)) +
labs(
title = "TNS Trip Volume by Region",
subtitle = "(Sep 2024 – Aug 2025)",
x = NULL, y = "Trips (volume)",
fill = "Region") +
theme_minimal(base_size = 12) +
theme(panel.grid.minor = element_blank(),
axis.text.x = element_text(vjust = 1, hjust = 0.5))
p_stacked
# If you want the grand total annotation inside the plot:
p_stacked +
annotate(
"text",
x = max(month_totals$ym),
y = max_month_total * 1.06,
label = paste0("Grand total: ", comma(grand_total)),
hjust = 1, vjust = 0, fontface = "bold"
)
# ---- 4) Chart B: small-multiples per Region (free y-scale, same colors) ----
p_facets <- ggplot(df_plot, aes(x = ym, y = volume, fill = Region)) +
geom_col(show.legend = FALSE) +
facet_wrap(~ Region, scales = "free_y") +
scale_fill_manual(values = pal) +   # <- same colors as stacked chart
scale_y_continuous(labels = label_comma(),
expand = expansion(mult = c(0, 0.05))) +
scale_x_date(date_breaks = "1 month", date_labels = "%b\n%Y",
expand = c(0.01, 0.01)) +
labs(
title = "TNS Trip Volume by Region (Sep 2024 – Aug 2025)",
subtitle = "Each panel uses its own y-scale",
x = NULL, y = "Trips (volume)"
) +
theme_minimal(base_size = 12) +
theme(panel.grid.minor = element_blank(),
strip.text = element_text(face = "bold"),
axis.text.x = element_text(vjust = 1, hjust = 0.5))
p_stacked
p_facets
# Packages
library(dplyr)
library(lubridate)
library(stringr)
library(ggplot2)
library(forcats)
library(scales)
# ---- 1) Filter & prepare (rename to Region) ----
df_plot <- df %>%
filter(
TRIP_SERVICE_TYPE_CODE == "TNS",
GEOSPATIAL_AREA_TYPE_CODE == "TNS_ZONE"
) %>%
mutate(
ym = make_date(yr, mth, 1),
# Clean raw zone text
zone_raw = str_trim(PICKUP_AREA),
zone_raw = na_if(zone_raw, ""),
zone_raw = if_else(!is.na(zone_raw) & str_to_upper(zone_raw) %in% c("NA","N/A","UNKNOWN"),
NA_character_, zone_raw),
# Extract numeric id (e.g., "ZONE 1" -> 1)
region_num = suppressWarnings(as.integer(str_extract(zone_raw, "\\d+"))),
# Friendly label + ordering key (Unknown last)
Region      = if_else(is.na(region_num), "Unknown area", paste0("Region ", region_num)),
region_order= if_else(is.na(region_num), 999L, region_num)
) %>%
# Window Sep 2024 ... Aug 2025
filter(ym >= as.Date("2024-09-01"), ym < as.Date("2025-09-01")) %>%
group_by(ym, Region, region_order) %>%
summarise(volume = sum(volume, na.rm = TRUE), .groups = "drop") %>%
mutate(Region = fct_reorder(Region, region_order, .desc = FALSE))
# Month totals + grand total
month_totals <- df_plot %>%
group_by(ym) %>%
summarise(total = sum(volume), .groups = "drop")
grand_total     <- sum(month_totals$total)
max_month_total <- max(month_totals$total)
# ---- 2) Lock a shared palette so both charts match ----
regions <- levels(df_plot$Region)
pal     <- setNames(scales::hue_pal()(length(regions)), regions)
# ---- 3) Chart A: stacked monthly total by Region (labels + same colors) ----
p_stacked <- ggplot(df_plot, aes(x = ym, y = volume, fill = Region)) +
geom_col() +
geom_text(
data = month_totals,
aes(x = ym, y = total, label = comma(total)),
vjust = -0.25, size = 3.5, fontface = "bold", inherit.aes = FALSE
) +
scale_fill_manual(values = pal) +
scale_y_continuous(labels = label_comma(),
expand = expansion(mult = c(0, 0.10))) +
scale_x_date(date_breaks = "1 month", date_labels = "%b\n%Y",
expand = c(0.01, 0.01)) +
labs(
title = "TNS Trip Volume by Region",
subtitle = "(Sep 2024 – Aug 2025)",
x = NULL, y = "Trips (volume)",
fill = "Region") +
theme_minimal(base_size = 12) +
theme(panel.grid.minor = element_blank(),
axis.text.x = element_text(vjust = 1, hjust = 0.5))
# If you want the grand total annotation inside the plot:
p_stacked +
annotate(
"text",
x = max(month_totals$ym),
y = max_month_total * 1.06,
label = paste0("Grand total: ", comma(grand_total)),
hjust = 1, vjust = 0, fontface = "bold"
)
# ---- 4) Chart B: small-multiples per Region (free y-scale, same colors) ----
p_facets <- ggplot(df_plot, aes(x = ym, y = volume, fill = Region)) +
geom_col(show.legend = FALSE) +
facet_wrap(~ Region, scales = "free_y") +
scale_fill_manual(values = pal) +   # <- same colors as stacked chart
scale_y_continuous(labels = label_comma(),
expand = expansion(mult = c(0, 0.05))) +
scale_x_date(date_breaks = "1 month", date_labels = "%b\n%Y",
expand = c(0.01, 0.01)) +
labs(
title = "TNS Trip Volume by Region (Sep 2024 – Aug 2025)",
subtitle = "Each panel uses its own y-scale",
x = NULL, y = "Trips (volume)"
) +
theme_minimal(base_size = 12) +
theme(panel.grid.minor = element_blank(),
strip.text = element_text(face = "bold"),
axis.text.x = element_text(vjust = 1, hjust = 0.5))
p_stacked
p_facets
# Packages
library(dplyr)
library(lubridate)
library(stringr)
library(ggplot2)
library(forcats)
library(scales)
# ---- 1) Filter & prepare (rename to Region) ----
df_plot <- df %>%
filter(
TRIP_SERVICE_TYPE_CODE == "TNS",
GEOSPATIAL_AREA_TYPE_CODE == "TNS_ZONE"
) %>%
mutate(
ym = make_date(yr, mth, 1),
# Clean raw zone text
zone_raw = str_trim(PICKUP_AREA),
zone_raw = na_if(zone_raw, ""),
zone_raw = if_else(!is.na(zone_raw) & str_to_upper(zone_raw) %in% c("NA","N/A","UNKNOWN"),
NA_character_, zone_raw),
# Extract numeric id (e.g., "ZONE 1" -> 1)
region_num = suppressWarnings(as.integer(str_extract(zone_raw, "\\d+"))),
# Friendly label + ordering key (Unknown last)
Region      = if_else(is.na(region_num), "Unknown area", paste0("Region ", region_num)),
region_order= if_else(is.na(region_num), 999L, region_num)
) %>%
# Window Sep 2024 ... Aug 2025
filter(ym >= as.Date("2024-09-01"), ym < as.Date("2025-09-01")) %>%
group_by(ym, Region, region_order) %>%
summarise(volume = sum(volume, na.rm = TRUE), .groups = "drop") %>%
mutate(Region = fct_reorder(Region, region_order, .desc = FALSE))
# Month totals + grand total
month_totals <- df_plot %>%
group_by(ym) %>%
summarise(total = sum(volume), .groups = "drop")
grand_total     <- sum(month_totals$total)
max_month_total <- max(month_totals$total)
# ---- 2) Lock a shared palette so both charts match ----
regions <- levels(df_plot$Region)
pal     <- setNames(scales::hue_pal()(length(regions)), regions)
# ---- 3) Chart A: stacked monthly total by Region (labels + same colors) ----
p_stacked <- ggplot(df_plot, aes(x = ym, y = volume, fill = Region)) +
geom_col() +
geom_text(
data = month_totals,
aes(x = ym, y = total, label = comma(total)),
vjust = -0.25, size = 3.5, fontface = "bold", inherit.aes = FALSE
) +
scale_fill_manual(values = pal) +
scale_y_continuous(labels = label_comma(),
expand = expansion(mult = c(0, 0.10))) +
scale_x_date(date_breaks = "1 month", date_labels = "%b\n%Y",
expand = c(0.01, 0.01)) +
labs(
title = "TNS Trip Volume by Region",
subtitle = "(Sep 2024 – Aug 2025)",
x = NULL, y = "Trips (volume)",
fill = "Region") +
theme_minimal(base_size = 12) +
theme(panel.grid.minor = element_blank(),
axis.text.x = element_text(vjust = 1, hjust = 0.5))
# If you want the grand total annotation inside the plot:
p_stacked +
annotate(
"text",
x = max(month_totals$ym),
y = max_month_total * 1.06,
label = paste0("Grand total: ", comma(grand_total)),
hjust = 1, vjust = 0, fontface = "bold"
)
# ---- 4) Chart B: small-multiples per Region (free y-scale, same colors) ----
p_facets <- ggplot(df_plot, aes(x = ym, y = volume, fill = Region)) +
geom_col(show.legend = FALSE) +
facet_wrap(~ Region, scales = "free_y") +
scale_fill_manual(values = pal) +   # <- same colors as stacked chart
scale_y_continuous(labels = label_comma(),
expand = expansion(mult = c(0, 0.05))) +
scale_x_date(date_breaks = "1 month", date_labels = "%b\n%Y",
expand = c(0.01, 0.01)) +
labs(
title = "TNS Trip Volume by Region (Sep 2024 – Aug 2025)",
subtitle = "Each panel uses its own y-scale",
x = NULL, y = "Trips (volume)"
) +
theme_minimal(base_size = 12) +
theme(panel.grid.minor = element_blank(),
strip.text = element_text(face = "bold"),
axis.text.x = element_text(vjust = 1, hjust = 0.5))
p_facets
trip_vol_qury_address <- '\\\\SFP.IDIR.BCGOV\\S143\\S86501\\PTBoard\\Initiatives\\Data Modelling & Policy Initiative\\Data Economic Modelling Projects\\2023_011_Indicators\\src\\trip_volume\\1_trip_volume_cube_fast.sql'
trip_vol_qury_query <- paste(readLines(trip_vol_qury_address, warn = F), collapse = "\n")
trip_vol <-dbGetQuery(con, trip_vol_qury_query)
save( trip_vol ,
file='W:\\PTBoard\\Initiatives\\Data Modelling & Policy Initiative\\Data Economic Modelling Projects\\2023_011_Indicators\\src\\trip_volume\\3_trip_volume_cube.Rda')
View(trip_vol)
